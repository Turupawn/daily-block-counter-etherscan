<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-100">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ETH Daily Block Count</title>
    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 2. Chart.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        /* A simple custom style for the color input swatches */
        input[type="color"] {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            width: 40px;
            height: 40px;
            padding: 0;
            border: none;
            border-radius: 0.375rem; /* rounded-md */
            cursor: pointer;
        }
        input[type="color"]::-webkit-color-swatch-wrapper {
            padding: 0;
            border-radius: 0.375rem;
        }
        input[type="color"]::-webkit-color-swatch {
            border: none;
            border-radius: 0.375rem;
        }
    </style>
</head>
<body class="h-full flex items-center justify-center p-4">
    <div class="w-full max-w-4xl bg-white rounded-2xl shadow-xl p-6 md:p-8">
        <h1 class="text-2xl md:text-3xl font-bold text-gray-800 text-center mb-6">
            EVM Chain Daily Block Count
        </h1>

        <!-- Controls Section -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
            <!-- API Key Input -->
            <div class="sm:col-span-2 lg:col-span-2">
                <label for="apiKey" class="block text-sm font-medium text-gray-700 mb-1">
                    Etherscan API Key
                </label>
                <input type="text" id="apiKey" placeholder="Get a free API key from etherscan.io (works for all chains)" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
            </div>

            <!-- Chain Select Dropdown -->
            <div>
                <label for="chainSelect" class="block text-sm font-medium text-gray-700 mb-1">Chain</label>
                <select id="chainSelect" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 bg-white">
                    <option value="534351|Scroll Sepolia">Scroll Sepolia (Testnet)</option>
                    <option value="11155111|Ethereum Sepolia">Ethereum Sepolia (Testnet)</option>
                    <option value="1|Ethereum Mainnet">Ethereum Mainnet</option>
                    <option value="534352|Scroll Mainnet">Scroll Mainnet</option>
                    <option value="10|Optimism">Optimism</option>
                    <option value="8453|Base">Base</option>
                    <option value="42161|Arbitrum One">Arbitrum One</option>
                    <option value="137|Polygon">Polygon</option>
                </select>
            </div>

            <!-- Date Inputs -->
            <div>
                <label for="startDate" class="block text-sm font-medium text-gray-700 mb-1">Start Date</label>
                <input type="date" id="startDate" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            <div>
                <label for="endDate" class="block text-sm font-medium text-gray-700 mb-1">End Date</label>
                <input type="date" id="endDate" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
            </div>

            <!-- Color Inputs -->
            <div class="flex items-end space-x-4">
                <div>
                    <label for="bgColor" class="block text-sm font-medium text-gray-700 mb-1">Bar</label>
                    <input type="color" id="bgColor" value="#4f46e5" class="shadow-sm">
                </div>
                <div>
                    <label for="borderColor" class="block text-sm font-medium text-gray-700 mb-1">Border</label>
                    <input type="color" id="borderColor" value="#3730a3" class="shadow-sm">
                </div>
            </div>
        </div>
        
        <!-- Button -->
        <div class="text-center mb-6">
            <button id="generateChartBtn" class="w-full sm:w-auto bg-indigo-600 text-white py-2 px-8 rounded-md shadow-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition-colors disabled:opacity-50"
            >
                Generate Chart
            </button>
        </div>

        <!-- Message Area -->
        <div id="messageArea" class="text-center min-h-[1.5em] mb-4 font-medium"></div>

        <!-- Chart Container -->
        <div class="w-full">
            <canvas id="blockChart"></canvas>
        </div>
    </div>

    <script>
        // --- DOM Elements ---
        const startDateInput = document.getElementById('startDate');
        const endDateInput = document.getElementById('endDate');
        const apiKeyInput = document.getElementById('apiKey');
        const chainSelect = document.getElementById('chainSelect');
        const bgColorInput = document.getElementById('bgColor');
        const borderColorInput = document.getElementById('borderColor');
        const generateBtn = document.getElementById('generateChartBtn');
        const messageArea = document.getElementById('messageArea');
        const ctx = document.getElementById('blockChart').getContext('2d');
        
        let myChart = null; // To hold the chart instance

        // --- Helper Function ---
        const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));

        // --- Set Default Dates ---
        function setDefaultDates() {
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(today.getDate() - 1);
            
            const thirtyDaysAgo = new Date(today);
            thirtyDaysAgo.setDate(today.getDate() - 30);

            // Format YYYY-MM-DD
            const formatDate = (date) => date.toISOString().split('T')[0];

            endDateInput.value = formatDate(yesterday);
            startDateInput.value = formatDate(thirtyDaysAgo);
        }
        setDefaultDates();

        // --- Attach Event Listener ---
        generateBtn.addEventListener('click', handleGenerateChart);

        // --- Main Function ---
        async function handleGenerateChart() {
            const startDate = new Date(startDateInput.value);
            const endDate = new Date(endDateInput.value);
            const apiKey = apiKeyInput.value.trim();
            const [chainId, chainName] = chainSelect.value.split('|');

            // 1. Validation
            if (!apiKey) {
                showMessage('Please enter an API Key.', 'error');
                return;
            }
            if (!startDateInput.value || !endDateInput.value) {
                showMessage('Please select both a start and end date.', 'error');
                return;
            }
            if (startDate > endDate) {
                showMessage('Start date must be before end date.', 'error');
                return;
            }

            generateBtn.disabled = true;
            showMessage('Fetching data... (This may take a moment)', 'loading');

            // 2. Loop through dates and fetch data
            try {
                const labels = [];
                const blockData = [];
                
                // Clone the start date to iterate
                let currentDate = new Date(startDate.getTime());

                while (currentDate <= endDate) {
                    const dateString = currentDate.toISOString().split('T')[0];
                    const niceDate = currentDate.toLocaleDateString();
                    showMessage(`Fetching data for ${niceDate}...`, 'loading');

                    const dayData = await getBlockCountForDay(dateString, apiKey, chainId);
                    
                    labels.push(niceDate);
                    blockData.push(dayData);

                    // Move to the next day
                    currentDate.setDate(currentDate.getDate() + 1);
                    
                    // Add a delay to avoid API rate limiting (5 calls/sec on free tier)
                    // We make 2 calls per day, so 250ms delay is > 500ms per day.
                    await delay(250); 
                }

                // 3. Render Chart
                renderChart(labels, blockData, chainName);
                showMessage('Chart generated successfully.', 'success');

            } catch (error)
            {
                console.error(error);
                showMessage(error.message, 'error');
            } finally {
                generateBtn.disabled = false;
            }
        }

        // --- New API Logic ---

        /**
         * Gets the total block count for a single day.
         */
        async function getBlockCountForDay(dateString, apiKey, chainId) {
            // Get timestamps for start and end of the day (in seconds)
            // Note: Etherscan uses UTC
            const startOfDay = new Date(`${dateString}T00:00:00.000Z`);
            const endOfDay = new Date(`${dateString}T23:59:59.000Z`);
            
            const startTimestamp = Math.floor(startOfDay.getTime() / 1000);
            const endTimestamp = Math.floor(endOfDay.getTime() / 1000);

            // Get block numbers at start and end of the day
            // We use 'before' for both to ensure we get a block *within* that day.
            const startBlock = await getBlockNumberAtTime(startTimestamp, apiKey, 'before', chainId);
            await delay(250); // Delay between calls to avoid rate limit
            const endBlock = await getBlockNumberAtTime(endTimestamp, apiKey, 'before', chainId);

            if (startBlock === 0 || endBlock === 0) {
                return 0; // Likely no blocks found for this day
            }
            
            // Handle case where start and end block are the same (low activity day)
            if (endBlock <= startBlock) {
                return 0; 
            }

            return endBlock - startBlock;
        }

        /**
         * Fetches a block number at a specific UTC timestamp.
         */
        async function getBlockNumberAtTime(timestamp, apiKey, closest, chainId) {
            // --- FIX ---
            // Using the Etherscan V2 unified API endpoint as requested.
            // chainid is now dynamic
            // module=block&action=getblocknobytime (Free endpoint)
            const apiUrl = `https://api.etherscan.io/v2/api?chainid=${chainId}&module=block&action=getblocknobytime&timestamp=${timestamp}&closest=${closest}&apikey=${apiKey}`;

            const response = await fetch(apiUrl);
            if (!response.ok) {
                // This catches 404, 500, etc.
                throw new Error('Network response was not ok.');
            }

            const data = await response.json();

            // This catches API-level errors (e.g., bad API key, rate limit)
            // V1/V2 API uses `status: "0"` or `message: "NOTOK"` for errors.
            if (data.status === "0" || data.message === "NOTOK") {
                const errorMessage = data.result || data.message || "Unknown API Error";
                // Provide a more helpful error if the key is invalid
                if (errorMessage.includes("Invalid API Key") || errorMessage.includes("invalid api key") || data.message === "NOTOK") {
                     throw new Error('API Error: Invalid API Key. Please get a key from etherscan.io and try again.');
                }
                throw new Error(`API Error: ${errorMessage}`);
            }

            // `getblocknobytime` returns the block number as a string in `result`
            return parseInt(data.result, 10);
        }


        // --- Chart.js Rendering ---
        function renderChart(labels, data, chainName) {
            const bgColor = bgColorInput.value;
            const borderColor = borderColorInput.value;

            // Destroy the old chart if it exists
            if (myChart) {
                myChart.destroy();
            }

            myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Daily Block Count',
                        data: data,
                        backgroundColor: bgColor,
                        borderColor: borderColor,
                        borderWidth: 2,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        title: {
                            display: true,
                            text: `${chainName} Blocks: ${labels[0]} to ${labels[labels.length - 1]}`,
                            font: { size: 16 }
                        },
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Block Count'
                            }
                        },
                        x: {
                             title: {
                                display: true,
                                text: 'Date'
                            }
                        }
                    }
                }
            });
        }

        // --- Utility Function ---
        function showMessage(message, type) {
            messageArea.textContent = message;
            messageArea.className = 'text-center min-h-[1.5em] mb-4 font-medium '; // Reset classes
            
            if (type === 'error') {
                messageArea.classList.add('text-red-600');
            } else if (type === 'success') {
                messageArea.classList.add('text-green-600');
            } else if (type === 'loading') {
                messageArea.classList.add('text-blue-600');
            }
        }
    </script>
</body>
</html>




